<div class="ibox">
    <div class="ibox-title text-center" >
        <h5> {{ _("Select the languages to be used with the participants") }}</h5>

        <div class="ibox-tools">
            <a class="btn btn-success btn-rounded  btn-xs" style="color: white" onclick="showHelp()"><i class="fa fa-question-circle"></i> {{  _("Show help") }}</a>
        </div>
    </div>

    <div class="ibox-content" >

        <select id="select_lang" name="select_lang" class="form-control chosen-select" tabindex="2">
            <option value="">{{ _("Select a language") }}</option>
            {% for lang in listOfLanguages %}
                <option value="{{ lang.lang_code }}">{{ lang.lang_name }}</option>
            {% endfor %}
        </select>

        <br>

        <div id="result_of_the_languages" style="margin-bottom: 20px; margin-top: 30px; {% if limiteHeight %}max-height: 300px;overflow-y: scroll;{% endif %}">

        </div>

    </div>
</div>

<script>

    $(document).ready(function() {

        $('.chosen-select').chosen({width: "100%"});

        updateUserLanguages();

        $("#select_lang").change(function (){
            var value = $(this).val();

            if (value !="")
            {
                $.ajax({
                    url: '{{ request.route_url('addUserLanguage', user=activeUser.login) }}',
                    datatype: "json",
                    type: "POST",
                    data: {
                        "csrf_token": '{{ request.session.get_csrf_token() }}',
                        "lang_code": value,
                    },
                    success: function (response) {
                        if (response["result"] == "success")
                        {
                            toastr.success(response["message"]);
                            $("#select_lang").val("");
                            $("#select_lang option[value='"+value+"']").remove();
                            $("#select_lang").trigger("chosen:updated");
                            updateUserLanguages();
                        }else{
                            toastr.error(response["message"]);
                        }

                    },
                    error: function (response) {
                        toastr.error("{{ _("There was a problem updating the languages") }}");
                    }
                });
            }
        });
    });

    function updateUserLanguages(){

        $.get("{{ request.route_url('getUserLanguagesPreview', user=activeUser.login) }}", function (dataJson, status) {

            $("#result_of_the_languages").html(dataJson)

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });

            $("input[name=default_language]").on('ifChecked',function(){

                $.ajax({
                    url: '{{ request.route_url('changeDefaultLanguage', user=activeUser.login) }}',
                    datatype: "json",
                    type: "POST",
                    data: {
                        "csrf_token": '{{ request.session.get_csrf_token() }}',
                        "lang_code": $("input[name=default_language]:checked").val(),
                    },
                    success: function (response) {
                        if (response["result"] == "success")
                        {
                            toastr.success(response["message"]);
                        }else{
                            toastr.error(response["message"]);
                        }

                    },
                    error: function (response) {
                        toastr.error("{{ _("There was a problem updating the default languages") }}");
                    }
                });
            });

        })
    }

    function myCustomAction(){
        updateUserLanguages();
    }



</script>