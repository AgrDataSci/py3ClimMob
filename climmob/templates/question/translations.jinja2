{% extends 'dashboard/dashboard.jinja2' %}

{% block title %}
    <title>{{ _("ClimMob | Question translations") }}</title>
{% endblock title %}

{% block css %}
    {% cssresource request,'coreresources','metro' %}
    {% cssresource request,'coreresources','sweet' %}
    {% cssresource request,'coreresources','shuffle' %}
    {% cssresource request,'coreresources','toastr' %}
    {% cssresource request,'coreresources','jsTree' %}
    {% cssresource request,'coreresources','switch' %}
    {% cssresource request,'coreresources','select2' %}
    {% cssresource request,'coreresources','datatimepicker' %}
    {% cssresource request,'coreresources','switchery' %}
    {% cssresource request,'coreresources','chosen' %}
    {% cssresource request,'coreresources','icheck' %}

{% endblock css %}

{% block topScripts %}
    {% jsresource request,'coreresources','qlibrary' %}
    {% jsresource request,'coreresources','sweet' %}
    {% jsresource request,'coreresources','bootstrapmaxlength' %}
    {% include 'snippets/delete.jinja2' %}
    {% jsresource request,'coreresources','switch' %}
    {% jsresource request,'coreresources','toastr' %}
    {% jsresource request,'coreresources','jstree' %}
    {% jsresource request,'coreresources','select2' %}
    {% jsresource request,'coreresources','validate' %}
    {% jsresource request,'coreresources','metro' %}
    {% jsresource request,'coreresources','datatimepicker' %}
    {% jsresource request,'coreresources','switchery' %}
    {% jsresource request,'coreresources','chosen' %}
    {% jsresource request,'coreresources','icheck' %}

{% endblock topScripts %}

{% block pageheading %}
    {% set iconOfLibrary="fa-language" %}
    {% set _title= _("Add other languages") %}
    {% set extra=[[_("Library questions"),request.route_url('qlibrary', user_name=activeUser.login)],[_("Question")+" : "+ questionDetails["question_name"], request.route_url('qlibrary', user_name=activeUser.login,_query={'questionId':questionDetails["question_id"]})]] %}
    {% set otherTitle=_("Add other languages") %}

    {% include 'snippets/menuheading.jinja2' %}
{% endblock %}

{% block pagecontent %}

    {% set allowEditing = True %}

    {% if questionDetails["user_name"] != activeUser.login %}
        {% set allowEditing = False %}
    {% endif %}


    <div class="row" >

        <div class="col-md-12 ">
            <div class="ibox">
                <div class="ibox-title" >
                    <h5>{{ _("Add other languages") }}</h5>

                    <div class="ibox-tools">
                        <a class="btn btn-success btn-rounded  btn-xs" style="color: white" data-toggle="modal" data-target="#languagesModal"><i class="fa fa-plus"></i> {{ _("Add more languages") }}</a>
                    </div>
                </div>
                <div class="ibox-content " >
                    <form class="form-horizontal formElement" role="form" method="post" action="{{ request.path }}">
                        <input type="hidden" name="csrf_token" value="{{ request.session.get_csrf_token() }}">
                        <div style="text-align: center; display: none" id="missingInfo">
                            <div class="alert alert-danger" >
                                {{  _("Please complete all fields marked in red in order to save the translations.") }}.
                            </div>
                        </div>
                        <table class="table table-striped table-bordered" >
                            <tbody>
                                <tr class="requiredProduct">
                                    <th  style="text-align: center">{{ _('Language') }}</th>
                                    <th  style="text-align: center">{{ _("Variable name") }}</th>

                                    {% if questionDetails["question_dtype"] not in [9,10] %}
                                        <th  style="text-align: center">{{ _("Question asked") }}</th>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [2,3,8] %}
                                        <th style="text-align: center">{{ _("Unit") }}</th>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [9] %}
                                        <th style="text-align: center">{{ _("Ranking - Best") }}</th>
                                        <th style="text-align: center">{{ _("Ranking - Worst") }}</th>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [10] %}
                                        <th style="text-align: center">{{ _("Question asked") }}</th>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [5,6] %}
                                        {% for option in questionDetails["question_options"] %}
                                            <th style="text-align: center">{{ _('Option') }} {{ option.value_code }}</th>
                                        {% endfor %}
                                    {% endif %}

                                    <th style="text-align: center">{{ _("Preview") }}</th>

                                </tr>
                                <tr style="text-align: center;">
                                    <th style="vertical-align: middle">{{ questionDetails["lang_name"] }} {{ _("(default)") }}</th>
                                    <td style="vertical-align: middle">{{ questionDetails["question_name"] }}</td>

                                    {% if questionDetails["question_dtype"] not in [9,10] %}
                                        <td style="vertical-align: middle">{{ questionDetails["question_desc"] }}</td>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [2,3,8] %}
                                        <td style="vertical-align: middle">{{ questionDetails["question_unit"] }}</td>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [9] %}
                                        <td style="vertical-align: middle">{{ questionDetails["question_posstm"] }}
                                        <td style="vertical-align: middle">{{ questionDetails["question_negstm"] }}
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [10] %}
                                        <td style="vertical-align: middle">{{ questionDetails["question_perfstmt"] }}</td>
                                    {% endif %}

                                    {% if questionDetails["question_dtype"] in [5,6] %}
                                        {% for option in questionDetails["question_options"] %}
                                            <td style="vertical-align: middle">{{ option.value_desc }}</td>
                                        {% endfor %}
                                    {% endif %}

                                    <td style="text-align: center">
                                        <button type="button" class="btn btn-primary" onclick="showPreview('{{ questionDetails["user_name"] }}',{{ questionDetails["question_id"] }},'{{ questionDetails["question_lang"] }}')">{{ _("Show preview") }}</button>
                                    </td>

                                </tr>
                                {% for lang in translations %}
                                    {% if lang["default"] != 1 %}
                                        <tr>
                                            <th style="vertical-align: middle">{{ lang["lang_name"] }}</th>
                                            <td style="vertical-align: middle">
{#                                                <div class="form-group has-error" style="margin: 0px">#}
                                                    <input class="form-control txt{{ lang.lang_code }}" type="text" id="question_name_{{ lang.lang_code }}" name="question_name_{{ lang.lang_code }}" value="{% if lang["translations"]["question_name"] %}{{ lang["translations"]["question_name"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the variable name.") }}')" onchange="this.setCustomValidity('')">
{#                                                </div>#}
                                            </td>

                                            {% if questionDetails["question_dtype"] not in [9,10] %}
                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_desc_{{ lang.lang_code }}" name="question_desc_{{ lang.lang_code }}" value="{% if lang["translations"]["question_desc"] %}{{ lang["translations"]["question_desc"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the question asked.") }}')" onchange="this.setCustomValidity('')"></td>
                                            {% endif %}

                                            {% if questionDetails["question_dtype"] in [2,3,8] %}
                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_unit_{{ lang.lang_code }}" name="question_unit_{{ lang.lang_code }}" value="{% if lang["translations"]["question_unit"] %}{{ lang["translations"]["question_unit"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the unit.") }}')" onchange="this.setCustomValidity('')">
                                            {% endif %}

                                            {% if questionDetails["question_dtype"] in [9] %}
                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_posstm_{{ lang.lang_code }}" name="question_posstm_{{ lang.lang_code }}" value="{% if lang["translations"]["question_posstm"] %}{{ lang["translations"]["question_posstm"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the ranking - Best.") }}')" onchange="this.setCustomValidity('')"></td>
                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_negstm_{{ lang.lang_code }}" name="question_negstm_{{ lang.lang_code }}" value="{% if lang["translations"]["question_negstm"] %}{{ lang["translations"]["question_negstm"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the ranking - Worst.") }}')" onchange="this.setCustomValidity('')"></td>
                                            {% endif %}

                                            {% if questionDetails["question_dtype"] in [10] %}
                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_perfstmt_{{ lang.lang_code }}" name="question_perfstmt_{{ lang.lang_code }}" value="{% if lang["translations"]["question_perfstmt"] %}{{ lang["translations"]["question_perfstmt"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the question asked.") }}')" onchange="this.setCustomValidity('')"></td>
                                            {% endif %}

                                            {% if questionDetails["question_dtype"] in [5,6] %}
                                                {% for option in questionDetails["question_options"] %}
                                                        {% if lang["default"] != 1 %}
                                                            {% set vars = {'value': ""} %}

                                                            {% for optionT in lang["translations"]["question_options"] %}
                                                                {% if optionT["value_code"] == option.value_code %}
                                                                    {% if vars.update({'value': optionT["value_desc"]}) %} {% endif %}

                                                                {% endif %}
                                                            {% endfor %}

                                                            <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="value_desc_{{ option.value_code }}_{{ lang.lang_code }}" name="value_desc_{{ option.value_code }}_{{ lang.lang_code }}" value="{{ vars.value }}" oninvalid="this.setCustomValidity('{{ _("Write the option.") }}')" onchange="this.setCustomValidity('')"></td>
                                                        {% endif %}
                                                {% endfor %}
                                            {% endif %}

                                            <td style="text-align: center">
                                                <button type="button" class="btn btn-primary" onclick="showPreview('{{ questionDetails["user_name"] }}',{{ questionDetails["question_id"] }},'{{ lang.lang_code }}')">{{ _("Show preview") }}</button>
                                            </td>

                                        </tr>
                                    {% endif %}
                                {% endfor %}
{#                                <tr>#}
{#                                    <th>{{ _('Field') }}</th>#}
{#                                    <th>{{ questionDetails["lang_name"] }} {{ _("(default)") }}</th>#}
{#                                    {% for lang in translations %}#}
{#                                        {% if lang["default"] != 1 %}#}
{#                                            <th style="text-align: center">{{ lang["lang_name"] }}</th>#}
{#                                        {% endif %}#}
{#                                    {% endfor %}#}
{#                                </tr>#}
{##}
{#                                <tr>#}
{#                                    <th>{{ _("Variable name") }}</th>#}
{#                                    <td>{{ questionDetails["question_name"] }}</td>#}
{#                                    {% for lang in translations %}#}
{#                                        {% if lang["default"] != 1 %}#}
{#                                            <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_name_{{ lang.lang_code }}" name="question_name_{{ lang.lang_code }}" value="{% if lang["translations"]["question_name"] %}{{ lang["translations"]["question_name"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the variable name.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                        {% endif %}#}
{#                                    {% endfor %}#}
{#                                </tr>#}
{##}
{#                                {% if questionDetails["question_dtype"] not in [9,10] %}#}
{#                                    <tr>#}
{#                                        <th>{{ _("Question asked") }}</th>#}
{#                                        <td>{{ questionDetails["question_desc"] }}</td>#}
{#                                        {% for lang in translations %}#}
{#                                            {% if lang["default"] != 1 %}#}
{#                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_desc_{{ lang.lang_code }}" name="question_desc_{{ lang.lang_code }}" value="{% if lang["translations"]["question_desc"] %}{{ lang["translations"]["question_desc"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the question asked.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
{#                                    </tr>#}
{#                                {% endif %}#}
{##}
{#                                <tr>#}
{#                                    <td>{{ _("Notes") }}</td>#}
{#                                    <td>{{ questionDetails["question_notes"] }}</td>#}
{#                                    {% for lang in translations %}#}
{#                                        {% if lang["default"] != 1 %}#}
{#                                            <td><input class="form-control" type="text" name="question_notes_{{ lang.lang_code }}" value="{% if lang["translations"]["question_notes"] %}{{ lang["translations"]["question_notes"] }}{% endif %}"></td>#}
{#                                        {% endif %}#}
{#                                    {% endfor %}#}
{#                                </tr>#}
{##}
{#                                {% if questionDetails["question_dtype"] in [2,3,8] %}#}
{#                                    <tr>#}
{#                                        <th>{{ _("Unit") }}</th>#}
{#                                        <td>{{ questionDetails["question_unit"] }}</td>#}
{#                                        {% for lang in translations %}#}
{#                                            {% if lang["default"] != 1 %}#}
{#                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_unit_{{ lang.lang_code }}" name="question_unit_{{ lang.lang_code }}" value="{% if lang["translations"]["question_unit"] %}{{ lang["translations"]["question_unit"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the unit.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
{#                                    </tr>#}
{#                                {% endif %}#}
{##}
{#                                {% if questionDetails["question_dtype"] in [9] %}#}
{#                                    <tr>#}
{#                                        <th>{{ _("Ranking - Best") }}</th>#}
{#                                        <td>{{ questionDetails["question_posstm"] }}</td>#}
{#                                        {% for lang in translations %}#}
{#                                            {% if lang["default"] != 1 %}#}
{#                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_posstm_{{ lang.lang_code }}" name="question_posstm_{{ lang.lang_code }}" value="{% if lang["translations"]["question_posstm"] %}{{ lang["translations"]["question_posstm"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the ranking - Best.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
{#                                    </tr>#}
{#                                {% endif %}#}
{##}
{#                                {% if questionDetails["question_dtype"] in [9] %}#}
{#                                    <tr>#}
{#                                        <th>{{ _("Ranking - Worst") }}</th>#}
{#                                        <td>{{ questionDetails["question_negstm"] }}</td>#}
{#                                        {% for lang in translations %}#}
{#                                            {% if lang["default"] != 1 %}#}
{#                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_negstm_{{ lang.lang_code }}" name="question_negstm_{{ lang.lang_code }}" value="{% if lang["translations"]["question_negstm"] %}{{ lang["translations"]["question_negstm"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the ranking - Worst.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
{#                                    </tr>#}
{#                                {% endif %}#}
{##}
{#                                {% if questionDetails["question_dtype"] in [10] %}#}
{#                                    <tr>#}
{#                                        <th>{{ _("Question asked") }}</th>#}
{#                                        <td>{{ questionDetails["question_perfstmt"] }}</td>#}
{#                                        {% for lang in translations %}#}
{#                                            {% if lang["default"] != 1 %}#}
{#                                                <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="question_perfstmt_{{ lang.lang_code }}" name="question_perfstmt_{{ lang.lang_code }}" value="{% if lang["translations"]["question_perfstmt"] %}{{ lang["translations"]["question_perfstmt"] }}{% endif %}" {% if not allowEditing %}readonly{% endif %} oninvalid="this.setCustomValidity('{{ _("Write the question asked.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                            {% endif %}#}
{#                                        {% endfor %}#}
{#                                    </tr>#}
{#                                {% endif %}#}
{##}
{#                                {% if questionDetails["question_dtype"] in [5,6] %}#}
{##}
{#                                    {% for option in questionDetails["question_options"] %}#}
{#                                        <tr>#}
{#                                            <th>{{ _('Option') }} {{ option.value_code }}</th>#}
{#                                            <td>{{ option["value_desc"] }}</td>#}
{#                                            {% for lang in translations %}#}
{#                                                {% if lang["default"] != 1 %}#}
{#                                                    {% set vars = {'value': ""} %}#}
{##}
{#                                                    {% for optionT in lang["translations"]["question_options"] %}#}
{#                                                        {% if optionT["value_code"] == option.value_code %}#}
{#                                                            {% if vars.update({'value': optionT["value_desc"]}) %} {% endif %}#}
{##}
{#                                                        {% endif %}#}
{#                                                    {% endfor %}#}
{##}
{#                                                    <td><input class="form-control txt{{ lang.lang_code }}" type="text" id="value_desc_{{ option.value_code }}_{{ lang.lang_code }}" name="value_desc_{{ option.value_code }}_{{ lang.lang_code }}" value="{{ vars.value }}" oninvalid="this.setCustomValidity('{{ _("Write the option.") }}')" onchange="this.setCustomValidity('')"></td>#}
{#                                                {% endif %}#}
{#                                            {% endfor %}#}
{#                                        </tr>#}
{#                                    {% endfor %}#}
{##}
{#                                {% endif %}#}
{##}
{#                                <tr>#}
{#                                    <th>{{ _("Preview") }}</th>#}
{#                                    <td style="text-align: center">#}
{#                                        <button type="button" class="btn btn-primary" onclick="showPreview('{{ questionDetails["user_name"] }}',{{ questionDetails["question_id"] }},'{{ questionDetails["question_lang"] }}')">{{ _("Show preview") }}</button>#}
{#                                    </td>#}
{#                                    {% for lang in translations %}#}
{#                                        {% if lang["default"] != 1 %}#}
{#                                            <td style="text-align: center">#}
{#                                                <button type="button" class="btn btn-primary" onclick="showPreview('{{ questionDetails["user_name"] }}',{{ questionDetails["question_id"] }},'{{ lang.lang_code }}')">{{ _("Show preview") }}</button>#}
{#                                            </td>#}
{#                                        {% endif %}#}
{#                                    {% endfor %}#}
{#                                </tr>#}
                            </tbody>
                        </table>


                        <div class="row text-center">
                            <button class="btn btn-primary" name="btn_save_translations" type="submit" id="btn_save_translations">{{ _("Save translations") }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-md-3 " id="ibox_preview" style="display: none">
            <div class="ibox">
                <div class="ibox-title" >
                    <h5>{{ _("Preview") }}</h5>
                </div>
                <div class="ibox-content " >
                    <div  class="text-center" id="divForPreview"></div>
                </div>
            </div>
        </div>

    </div>

    {% include 'snippets/languages/addMoreLanguages.jinja2' %}

    <style>


        .fieldWithProblem {
            border: 1px solid red;
        }

    </style>

    <script>

        $(document).ready(function (){
            {% for lang in translations %}
                {% if lang["default"] != 1 %}
                    $(".txt{{ lang.lang_code }}").keyup(function (){

                        console.log(".txt{{ lang.lang_code }}")
                        var required = false;

                        $(".txt{{ lang.lang_code }}").each(function() {
                            if ($(this).val() !== ""){
                                required = true
                            }
                        });

                        if (required === true)
                        {

                            $(".txt{{ lang.lang_code }}").each(function () {

                                if ($(this).val() === "") {
                                    $(this).addClass("fieldWithProblem")
                                    $("#missingInfo").css("display", "block")
                                } else {
                                    $(this).removeClass("fieldWithProblem")
                                }

                            });
                        }else{
                            $(".txt{{ lang.lang_code }}").removeClass("fieldWithProblem")
                        }

                    });
                {% endif %}
            {% endfor %}




        });

        $(".form-control").keyup(function (){
            $(".form-control").each(function() {
                if ( $(this).hasClass( "fieldWithProblem" ) === true){
                    $("#missingInfo").css("display", "none")
                }
            });
        })

        $(".formElement").click(function () {
            var problems = true;
            $(".form-control").each(function() {
                if ( $(this).hasClass( "fieldWithProblem" ) === true){
                    problems = false
                }
            });

            return problems

          });

        {#$(".formElement").submit(function (e) {#}
        {#      alert( "Handler for `submit` called." );#}
        {#      e.preventDefault();#}
        {#      alert("sale")#}
        {#        return#}
        {#    });#}

        function showPreview(user_name, question_id, language)
        {
            var URL = "{{ request.route_url('getUserQuestionPreviewInCustomLanguage',user="__user_name__", questionid="__questionid__", language="__language__") }}"
            URL = URL.replace("__user_name__", user_name).replace("__questionid__", question_id).replace("__language__", language)

            $.get(URL, function (data, status) {
                $("#divForPreview").html(data);
                $("#ibox_preview").css('display','initial');
            })
        }
    </script>


{% endblock pagecontent %}